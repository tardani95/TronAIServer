<!DOCTYPE html>
<html>

<head>
    <title>TronAI WebGUI</title>
</head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
    body, h1, h2, h3, h4, h5, h6 {
        font-family: "Raleway", sans-serif
    }

    body, html {
        height: 100%;
        line-height: 1.8;
    }

    /* Full height image header */
    .bgimg-1 {
        background-position: center;
        background-size: cover;
        background-image: url("http://payload487.cargocollective.com/1/0/2995/12059511/TRON_MR_fr42_1500.jpg");
        /*https://futureoflife.org/wp-content/uploads/2015/11/artificial_intelligence_benefits_risk.jpg*/
        min-height: 100%;
    }

    .w3-bar .w3-button {
        padding: 16px;
    }

    /*TODO - slide in*/



</style>

<body onload="javascript:subscribeToWebSocket()">
<!--<body>-->

<!-- Navbar (sit on top) -->
<div class="w3-top">
    <div class="w3-bar w3-white w3-card" id="myNavbar">
        <a href="#home" class="w3-bar-item w3-button w3-wide">TRON</a>
        <!-- Right-sided navbar links -->
        <div class="w3-right w3-hide-small">
            <a href="#about" class="w3-bar-item w3-button">DOWNLOAD CLIENT</a>
            <!--<a href="#team" class="w3-bar-item w3-button"><i class="fa fa-user"></i> TEAM</a>-->
            <!--<a href="#work" class="w3-bar-item w3-button"><i class="fa fa-th"></i> WORK</a>-->
            <!--<a href="#pricing" class="w3-bar-item w3-button"><i class="fa fa-usd"></i> PRICING</a>-->
            <!--<a href="#contact" class="w3-bar-item w3-button"><i class="fa fa-envelope"></i> CONTACT</a>-->
        </div>
        <!-- Hide right-floated links on small screens and replace them with a menu icon -->

        <a href="javascript:void(0)" class="w3-bar-item w3-button w3-right w3-hide-large w3-hide-medium" onclick="w3_open()">
            <i class="fa fa-bars"></i>
        </a>
    </div>
</div>

<!-- Sidebar on small screens when clicking the menu icon -->
<nav class="w3-sidebar w3-bar-block w3-black w3-card w3-animate-left w3-hide-medium w3-hide-large" style="display:none" id="mySidebar">
    <a href="javascript:void(0)" onclick="w3_close()" class="w3-bar-item w3-button w3-large w3-padding-16">Close Ã—</a>
    <a href="#about" onclick="w3_close()" class="w3-bar-item w3-button">ABOUT</a>
    <a href="#team" onclick="w3_close()" class="w3-bar-item w3-button">TEAM</a>
    <a href="#work" onclick="w3_close()" class="w3-bar-item w3-button">WORK</a>
    <a href="#pricing" onclick="w3_close()" class="w3-bar-item w3-button">PRICING</a>
    <a href="#contact" onclick="w3_close()" class="w3-bar-item w3-button">CONTACT</a>
</nav>

<!-- Header with full-height image -->
<header class="bgimg-1 w3-display-container w3-grayscale-min" id="home">
    <div class="w3-display-center w3-text-white" align="center">
        <div style="padding-top:70px">
            <canvas id="myCanvas" width="1000" height="700" style="border:4px solid #000000; display:none; "></canvas>
            <ul  id="scoreBoard" class="w3-ul w3-card-4" style="width: 400px;display:inline-block; vertical-align: top; padding-top: 40px"></ul>
        </div>
        <span class="w3-jumbo w3-hide-small" id="message">Connecting...</span><br>
        <span class="w3-xxlarge w3-hide-large w3-hide-medium">Start something that matters</span><br>
        <!--<span class="w3-large">Stop wasting valuable time with projects that just isn't you.</span>-->
        <!--<p><a href="#about" class="w3-button w3-white w3-padding-large w3-large w3-margin-top w3-opacity w3-hover-opacity-off">Learn more and start today</a></p>-->
    </div>
    <div class="w3-display-bottomleft w3-text-grey w3-large" >
        <i class="fa fa-facebook-official w3-hover-opacity"></i>
        <i class="fa fa-instagram w3-hover-opacity"></i>
        <i class="fa fa-snapchat w3-hover-opacity"></i>
        <i class="fa fa-pinterest-p w3-hover-opacity"></i>
        <i class="fa fa-twitter w3-hover-opacity"></i>
        <i class="fa fa-linkedin w3-hover-opacity"></i>
    </div>
</header>

<input id="userInput" type="text">
<button onclick="javascript:sendMessage()">Chat</button>
<!--<div id="message"></div>-->


<script>
    var socket;
    var canvas = document.getElementById('myCanvas');
    var gc = canvas.getContext("2d");
    var CELL_SIZE = 20;
    var MAP_SIZE_X = 50;
    var MAP_SIZE_Y = 35;
    var BODY_SCALE = 0.5;
    var scoreBoard = document.getElementById('scoreBoard');
    var numOfPlayers = 0;
    initWindow();



    function initWindow() {
        canvas.width = CELL_SIZE * MAP_SIZE_X;
        canvas.height = CELL_SIZE * MAP_SIZE_Y;
    }

    function drawBaseMap() {
        gc.fillStyle = "#FFFFFF";
        gc.fillRect(0, 0, canvas.width, canvas.height);
        gc.beginPath();
        gc.lineWidth = 0.5;
        for (i = 1; i < MAP_SIZE_X; i++) {
            gc.moveTo(i * CELL_SIZE, 0);
            gc.lineTo(i * CELL_SIZE, canvas.height);
        }

        for (j = 1; j < MAP_SIZE_Y; j++) {
            gc.moveTo(0, j * CELL_SIZE);
            gc.lineTo(canvas.width, j * CELL_SIZE);
        }
        gc.stroke();
    }

    function removePlayer(index){
        var pid='player'+index;
        var item = document.getElementById(pid);
        scoreBoard.removeChild(item);
    }
    function addNewPlayer(player) {
        var listItem = document.createElement('li');
        listItem.setAttribute('id', 'player'+player.id);
        listItem.setAttribute('style',"background: "+player.color+"; alignment: left");
        listItem.setAttribute('class',"w3-bar");

        var playerName = document.createElement('span');
        playerName.appendChild(document.createTextNode(player.id));
        playerName.setAttribute('style', "padding: 20px")

        var score = document.createElement('span');
        score.appendChild(document.createTextNode(player.score))

        listItem.appendChild(playerName);
        listItem.appendChild(score);
        scoreBoard.appendChild(listItem);
    }


    function drawPlayers(gameData) {
        drawBaseMap();
        //draw achievement
        gc.fillStyle = "#FF0000";
        gc.fillRect(CELL_SIZE * gameData.achievements.coord.x, CELL_SIZE * gameData.achievements.coord.y, CELL_SIZE, CELL_SIZE);
        var index = 0;
        //gc.beginPath();
        for (player of gameData.players) {

            if(Number(player.id)>Number(index)){
                removePlayer(player.id);
                numOfPlayers++;
                index=player.id;
            }
            if(player.id>=numOfPlayers){
                numOfPlayers=index+1;
                addNewPlayer(player);
            }
            gc.beginPath();
            gc.fillStyle = player.color;
            gc.fillRect(CELL_SIZE * player.head.x, CELL_SIZE * player.head.y, CELL_SIZE, CELL_SIZE);
            gc.strokeStyle = player.color;
            gc.lineWidth = CELL_SIZE * BODY_SCALE;
            if (player.tail.length != 0) {
                //draw neck
                gc.moveTo(CELL_SIZE * (player.head.x + 0.5),
                    CELL_SIZE * (player.head.y + 0.5));
                gc.lineTo(CELL_SIZE * (player.tail[0].x + 0.5),
                    CELL_SIZE * (player.tail[0].y + 0.5));

                //draw body
                for (i = 1; i < player.tail.length; i++) {
                    strokeLine(CELL_SIZE * (player.tail[i - 1].x + 0.5),
                        CELL_SIZE * (player.tail[i - 1].y + 0.5),
                        CELL_SIZE * (player.tail[i].x + 0.5),
                        CELL_SIZE * (player.tail[i].y + 0.5)); //draw body
                }
            }
            gc.stroke();
            index++;
        }
        if(index<numOfPlayers){
            for(var i=index; i<numOfPlayers; i++){
                removePlayer(i);
                numOfPlayers--;
            }
        }

        //gc.stroke();
        gc.strokeStyle = "#000000";
    }

    function strokeLine(x, y, x1, y1) {
        gc.moveTo(x, y);
        gc.lineTo(x1, y1);
    }

    function drawLine() {
        ctx.moveTo(0, 0);
        ctx.lineTo(200, 100);
        ctx.stroke();
    }

    var text1 = '{ "employees" : [' +
        '{ "firstName":"John" , "lastName":"Doe" },' +
        '{ "firstName":"Anna" , "lastName":"Smith" },' +
        '{ "firstName":"Peter" , "lastName":"Jones" } ]}';

    function refreshGUI(obj) {
        //document.getElementById('message').innerHTML = gameData.achievements.coord.x;
        drawPlayers(obj);
    }

    function sendMessage() {
        var message = document.getElementById('userInput').value;
        socket.send(message);
    }

    function showMessage(text) {
        document.getElementById('message').innerHTML = text;
    }

    function subscribeToWebSocket() {
        if ('WebSocket' in window) {
            socket = new WebSocket('ws://localhost:8090/websocket');
            socket.onopen = function () {
                drawBaseMap();
                canvas.style.display="inline-block";
                showMessage('Connected to WebSocket as GUEST');
                socket.send('GUEST');
            };
            socket.onmessage = function (msg) {
                //showMessage(msg.data);
                refreshGUI(JSON.parse(msg.data));
            };
            socket.onerror = function (msg) {
                showMessage('Sorry but there was an error.');
            };
            socket.onclose = function () {
                canvas.style.display="none";
                showMessage('Server offline.');
                sleep(2000);
                subscribeToWebSocket();
            };
        } else {
            showMessage('Your browser does not support HTML5 WebSockets.');
        }
    }

    function sleep (time) {
        return new Promise((resolve) => setTimeout(resolve, time));
    }
</script>

</body>

</html>